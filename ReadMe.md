# CVE Analysis

## Overview
This projects works with Vulnerability API from NVD for providing security analytics over
registered vulnerabilities in commercial and open source software.
It ingests vulnerability data from **05-01-2024** for the next 360 days.
This project contains the following components:
- **PostgreSQL**
- **Database Migrator**
- **Ingestion Pipeline Script**
- **Service API**

This project is built on top of my another Spring Boot starter project to simplify
API and database development. By default, it also has additional user/auth/permission
database tables and API that come from my starter project. 
The ingestion data pipeline script is written in Python 3 to simplify ETL process.
It uses batch data insert to avoid database connection pool overload and IO.
Analytics sql queries are located in **AnalyticsRepository.kt**.
Project was developed and tested on Apple M1 Max, Sonoma 14.6

### PostgreSQL
Is chosen as the most simple and popular relational database

### Database Migrator
Comes from my Spring Boot starter project that is responsible for any database
schema changes and migrations.

### Ingestion Pipeline Script
Simple script that works with NVD API, groups provided data and saves it to Postres database.

### Service API
Provides Swagger API to get analytics about ingested data.

## Data Model
The data model is designed to keep vulnerabilities, vulnerability metrics and products.
Vulnerabilities are related with product by product versions such that it is
quite easy to find product's vulnerabilities.
Relational model was built with **dbdiagram.io**
![alt text](db-relation.png "Title")

### Tables and Columns

#### Table: `products`

| Column Name   | Data Type     | Description                                      |
|---------------|---------------|--------------------------------------------------|
| `id`          | UUID          | Primary key, unique identifier for each product. |
| `product_name`| VARCHAR(255)  | Name of the product. (light-oauth2, firefox_esr) |
| `vendor_name` | VARCHAR(255)  | Name of the vendor. (samsung, apple)             |

- **Unique Constraints**: Combination of `product_name` and `vendor_name` must be unique.

#### Table: `product_versions`

| Column Name   | Data Type     | Description                                                  |
|---------------|---------------|--------------------------------------------------------------|
| `id`          | UUID          | Primary key, unique identifier for each product version.     |
| `product_id`  | UUID          | Foreign key referencing `products(id)`.                      |
| `version`     | VARCHAR(255)  | Version of the product. (5.0.1.2137, 4.3.1, * - not defined) |

- **Foreign Key Constraints**:
  - `product_id` references `products(id)` and cascades on delete.

#### Table: `vulnerabilities`

| Column Name         | Data Type     | Description                                               |
|---------------------|---------------|-----------------------------------------------------------|
| `id`                | UUID          | Primary key, unique identifier for each vulnerability.    |
| `cve_id`            | VARCHAR(255)  | Unique identifier for the CVE.            |
| `description`       | TEXT          | Description of the vulnerability.         |
| `published_date`    | DATE          | Date when the vulnerability was published.|
| `last_modified_date`| DATE          | Date when the vulnerability was last modified.|

- **Unique Constraints**: `cve_id` must be unique.

#### Table: `vulnerability_metrics`

| Column Name            | Data Type     | Description                                                           |
|------------------------|---------------|-----------------------------------------------------------------------|
| `id`                   | UUID          | Primary key, unique identifier for each metric.                       |
| `vulnerability_id`     | UUID          | Foreign key referencing `vulnerabilities(id)`.                        |
| `metric_name`          | VARCHAR(255)  | Name of the metric. (cvssMetricV2, cvssMetricV31)                     |
| `metric_type`          | VARCHAR(255)  | Type of the metric.  (Secondary, Primary)                             |
| `version`              | VARCHAR(50)   | Version of the metric. (2.0, 4.0)                                     |
| `vector_string`        | VARCHAR(255)  | Vector string  (CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:L)         |
| `attack_vector`        | VARCHAR(255)  | Attack vector. (LOCAL, ADJACENT_NETWORK, PHYSICAL, NULL               |
| `attack_complexity`    | VARCHAR(255)  | Complexity of the attack. (HIGH, LOW, NULL)                           |
| `privileges_required`  | VARCHAR(255)  | Required privileges for the attack. (HIGH, LOW, NULL, NONE)           |
| `user_interaction`     | VARCHAR(255)  | User interaction requirement. (PASSIVE, REQUIRED, ACTIVE, NONE, NULL) |
| `confidentiality_impact`| VARCHAR(255) | Impact on confidentiality. (NONE, HIGH, PARTIAL, LOW, COMPLETE)       |
| `integrity_impact`     | VARCHAR(255)  | Impact on integrity.  (HIGH, PARTIAL, LOW, COMPLETE)                  |
| `availability_impact`  | VARCHAR(255)  | Impact on availability. (HIGH, PARTIAL, LOW, COMPLETE)                |
| `base_score`           | FLOAT         | Base score of the metric. (0.0 - 10.0)                                |
| `base_severity`        | VARCHAR(50)   | Severity of the base score. (MEDIAUM, CRITICAL, HIGH)                 |
| `exploitability_score` | FLOAT         | Exploitability score. (0.0 - 10.0)                                    |
| `impact_score`         | FLOAT         | Impact score. (0.0 - 10.0, NULL)                                      |

- **Foreign Key Constraints**:
  - `vulnerability_id` references `vulnerabilities(id)` and cascades on delete.

#### Table: `product_vulnerabilities`

| Column Name         | Data Type     | Description                                                |
|---------------------|---------------|------------------------------------------------------------|
| `id`                | UUID          | Primary key, unique identifier for each record.            |
| `product_version_id`| UUID          | Foreign key referencing `product_versions(id)`.            |
| `vulnerability_id`  | UUID          | Foreign key referencing `vulnerabilities(id)`.             |

- **Foreign Key Constraints**:
  - `product_version_id` references `product_versions(id)` and cascades on delete.
  - `vulnerability_id` references `vulnerabilities(id)` and cascades on delete.



## Prerequisites
Before you begin, ensure you have the following tools installed:
- **SDKMAN!**: For MacOS and Linux users to manage dev tools
- **Gradle 8.9** : Java build tool, better to be installed with **SDKMAN!**
- **Java 21**: Temurin JDK, better to be installed with **SDKMAN!**
- **Docker or Podman**
- **Python 3**
- **pip**
- **NIST API Key**: NIST API requires api key, please create personal api key to ingest the data: https://nvd.nist.gov/developers/request-an-api-key

## Installation
### Database
Two options, depending on a local setup **Docker** or **Podman**.
The compose command will run the database defined in `docker-compose.yaml`

**Running PostgreSQL with Docker**

To run the database using Docker, execute:
```bash
docker-compose up
```

To run without logs

```bash
docker-compose up -d
```

**Or running PostgreSQL with Podman**

To run the database using Podman, execute:
```bash
podman-compose up
```

To run without logs
```bash
podman-compose up -d
```

### Database Migrator
Before running the data ingestion pipeline and REST API, create all database tables.
Tables are located in **002-initial-schema-cve.sql**

**Build Spring Boot project with Gradle**
```bash
./gradlew build
```

**Run migration**
```bash
./gradlew :db-migrator:run
```

### Data Ingestion Pipeline
The pipeline uses Python 3 and venv. It is located in data-ingest directory.

```bash
cd data_ingest
```

**Activate the Virtual Environment**

- On **Windows**:

    ```bash
    venv\Scripts\activate
    ```

- On **Unix or MacOS**:

    ```bash
    source venv/bin/activate
    ```

**Install Dependencies with PIP**

Dependencies listed in the `requirements.txt` file.

```bash
pip install -r requirements.txt
```

**Set API Key**

Open **cve_ingestion_pipeline.py** and set your api key at line 21.
```
api_key = 'your_key'
```

**Run the Data Ingestion**

With the virtual environment activated and dependencies installed, 
you can now run the ingest pipeline. 
Logs from the pipeline should show process life cycle.

```bash
python3 cve_ingestion_pipeline.py
```

Once the pipeline is finished, the REST API is ready to be running.


### REST API
Run the following command from the project root directory

```bash
./gradlew :app:run
```

Once the project is running the API must 
be available from Swagger at http://localhost:8080/api/v1/swagger-ui/index.html
User Swagger to try out API.

## Coming Soon
UI App for analytics visualisation with Next.js and schadcn UI https://ui.shadcn.com/

Based on another hobby project that is early stage development https://github.com/modulus100/mek-ui