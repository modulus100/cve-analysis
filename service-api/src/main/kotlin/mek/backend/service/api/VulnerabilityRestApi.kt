package mek.backend.service.api

import io.swagger.v3.oas.annotations.Operation
import io.swagger.v3.oas.annotations.Parameter
import io.swagger.v3.oas.annotations.media.Content
import io.swagger.v3.oas.annotations.media.Schema
import io.swagger.v3.oas.annotations.responses.ApiResponse
import io.swagger.v3.oas.annotations.responses.ApiResponses
import io.swagger.v3.oas.annotations.tags.Tag
import mek.backend.analytics.api.VulnerabilitySearchRequest
import mek.backend.analytics.api.VulnerabilitySearchResponse
import mek.backend.analytics.service.AnalyticsService
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.RequestMapping
import org.springframework.web.bind.annotation.RequestParam
import org.springframework.web.bind.annotation.RestController
import java.time.Instant


@Tag(name = "Vulnerability", description = "Vulnerability related endpoints")
@RequestMapping("/vulnerability")
@RestController
class VulnerabilityRestApi(
    val analyticsService: AnalyticsService
) {

    @Operation(summary = "Search vulnerabilities by publish date, modified data and CVE ID")
    @GetMapping("search")
    @ApiResponses(
        value = [
            ApiResponse(
                responseCode = "200",
                description = "Successful processed search",
                content = [
                    Content(schema = Schema(implementation = VulnerabilitySearchResponse::class))
                ]
            )
        ]
    )
    fun searchProduct(
        @Parameter(
            description = "CVE ID of the vulnerability",
            schema = Schema(example = "CVE-2022-29778")
        )
        @RequestParam
        cveId: String?,

        @Parameter(
            description = "Start date of the publish date range (inclusive)",
            schema = Schema(example = "2022-01-01T00:00:00Z")
        )
        @RequestParam
        publishDateStart: Instant?,

        @Parameter(
            description = "End date of the publish date range (inclusive)",
            schema = Schema(example = "2024-07-31T23:59:59Z")
        )
        @RequestParam
        publishDateEnd: Instant?,

        @Parameter(description = "Start date of the last modified date range (inclusive)")
        @RequestParam
        lastModifiedDateStart: Instant?,

        @Parameter(description = "End date of the last modified date range (inclusive)")
        @RequestParam
        lastModifiedDateEnd: Instant?
    ): VulnerabilitySearchResponse {
        return analyticsService.searchVulnerabilities(
            VulnerabilitySearchRequest(
                cveId = cveId,
                publishDateStart = publishDateStart,
                publishDateEnd = publishDateEnd,
                lastModifiedDateStart = lastModifiedDateStart,
                lastModifiedDateEnd = lastModifiedDateEnd
            )
        )
    }
}